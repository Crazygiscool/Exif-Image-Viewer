<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Integrated EXIF Viewer & Editor</title>
  <script src="https://cdn.jsdelivr.net/npm/exif-js"></script>
  <script src="https://cdn.jsdelivr.net/npm/leaflet/dist/leaflet.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet/dist/leaflet.css" />
  <style>
    /* Core Styles */
    body {
      font-family: "Courier New", Courier, monospace;
      margin: 0;
      display: flex;
      flex-direction: column;
      height: 100vh;
      background-color: #000000;
      color: #00FF00;
    }

    #container {
      display: flex;
      flex: 1;
    }

    #sidebar {
      width: 20%;
      padding: 10px;
      overflow-y: auto;
      background-color: #001a00;
      border-right: 1px solid #00FF00;
    }

    #main {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 15px;
    }

    h1, h3 {
      margin: 0;
    }

    p {
      margin: 5px 0 10px;
    }

    #dropZone {
      margin: 10px 0;
      padding: 15px;
      border: 2px dashed #00FF00;
      border-radius: 5px;
      text-align: center;
      cursor: pointer;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 10px;
    }

    table th, table td {
      padding: 8px;
      border: 1px solid #00FF00;
      text-align: left;
    }

    /* Static Column Width */
    table th, table td {
      max-width: 200px;
      word-wrap: break-word;
      white-space: pre-wrap; /* Wrap text within the cell */
    }

    table td.editable {
      cursor: pointer;
      background-color: #002200;
    }

    table td.editable:hover {
      background-color: #003300;
    }

    #saveButton {
      padding: 10px 20px;
      cursor: pointer;
      text-align: center;
      background-color: #003300;
      color: #00FF00;
      border: 1px solid #00FF00;
      border-radius: 5px;
      transition: background-color 0.3s ease;
    }

    #saveButton:hover {
      background-color: #004d00;
    }

    /* Map Styling */
    #mapContainer {
      margin-top: 10px;
      padding: 10px;
      background-color: #001a00;
      border: 1px solid #00FF00;
      border-radius: 5px;
    }

    #map {
      height: 300px;
      border: 1px solid #00FF00;
    }

    #googleMapsLink {
      color: #00FF00;
      display: block;
      margin-top: 10px;
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <div id="container">
    <!-- Sidebar -->
    <div id="sidebar">
      <h3>Uploaded Images</h3>
      <div id="fileList">No files uploaded yet.</div>
    </div>

    <!-- Main Area -->
    <div id="main">
      <h1>Integrated EXIF Viewer & Editor</h1>
      <p>Drag and drop an image below or click to upload:</p>
      <div id="dropZone">Drag and drop an image here or click to upload</div>

      <!-- Integrated Viewer & Editor -->
      <div id="viewerEditor">
        <h3>EXIF Metadata</h3>
        <table id="metadataTable">
          <thead>
            <tr>
              <th>Key</th>
              <th>Value</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <button id="saveButton">Save and Download Metadata</button>
      </div>

      <!-- Map Section -->
      <div id="mapContainer">
        <h3>Location Map</h3>
        <div id="map"></div>
        <!-- Google Maps Link -->
        <a id="googleMapsLink" href="#" target="_blank" style="display: none;">View on Google Maps</a>
      </div>
    </div>
  </div>

  <script>
    const dropZone = document.getElementById('dropZone');
    const fileList = document.getElementById('fileList');
    const metadataTable = document.getElementById('metadataTable').querySelector('tbody');
    const saveButton = document.getElementById('saveButton');
    const mapContainer = document.getElementById('mapContainer');
    const googleMapsLink = document.getElementById('googleMapsLink');
    let currentMetadata = {};
    let mapInitialized = false;
    let map;

    // Handle Drag-and-Drop
    dropZone.addEventListener('dragover', event => {
      event.preventDefault();
      dropZone.classList.add('dragging');
    });

    dropZone.addEventListener('dragleave', () => {
      dropZone.classList.remove('dragging');
    });

    dropZone.addEventListener('drop', event => {
      event.preventDefault();
      dropZone.classList.remove('dragging');
      const file = event.dataTransfer.files[0];
      if (!file) {
        alert('No file selected!');
        return;
      }
      handleFile(file);
    });

    dropZone.addEventListener('click', () => {
      const fileInput = document.createElement('input');
      fileInput.type = 'file';
      fileInput.accept = 'image/*';
      fileInput.addEventListener('change', event => {
        const file = event.target.files[0];
        handleFile(file);
      });
      fileInput.click();
    });

    function handleFile(file) {
      if (!file.type.startsWith('image/')) {
        alert('Please upload a valid image file.');
        return;
      }

      const reader = new FileReader();
      reader.onload = event => {
        const img = new Image();
        img.src = URL.createObjectURL(file);
        img.onload = () => {
          EXIF.getData(img, function () {
            currentMetadata = EXIF.getAllTags(this);
            displayMetadata(currentMetadata);
            addFileToList(file.name);
          });
        };
      };
      reader.readAsArrayBuffer(file);
    }

    function displayMetadata(metadata) {
      metadataTable.innerHTML = '';
      for (const [key, value] of Object.entries(metadata)) {
        const row = document.createElement('tr');
        const keyCell = document.createElement('td');
        const valueCell = document.createElement('td');
        keyCell.textContent = key;
        valueCell.textContent = value;
        valueCell.classList.add('editable');
        valueCell.addEventListener('click', () => editMetadataValue(key, valueCell));
        row.appendChild(keyCell);
        row.appendChild(valueCell);
        metadataTable.appendChild(row);
      }

      // If GPS data is available, show it on the map
      if (metadata.GPSLatitude && metadata.GPSLongitude) {
        showMap(metadata.GPSLatitude, metadata.GPSLongitude, metadata.GPSLatitudeRef, metadata.GPSLongitudeRef);
      }
    }

    function addFileToList(fileName) {
      const fileItem = document.createElement('div');
      fileItem.textContent = fileName;
      fileItem.className = 'file-item';
      fileList.appendChild(fileItem);
      fileItem.addEventListener('click', () => {
        alert(`Selected file: ${fileName}`);
      });
    }

    function editMetadataValue(key, cell) {
      const oldValue = cell.textContent;
      const input = document.createElement('input');
      input.type = 'text';
      input.value = oldValue;
      input.style.width = '100%';
      input.addEventListener('blur', () => {
        const newValue = input.value;
        cell.textContent = newValue;
        currentMetadata[key] = newValue;

        // Update the map if GPS data is edited
        if (key === 'GPSLatitude' || key === 'GPSLongitude' || key === 'GPSLatitudeRef' || key === 'GPSLongitudeRef') {
          const { GPSLatitude, GPSLongitude, GPSLatitudeRef, GPSLongitudeRef } = currentMetadata;
          if (GPSLatitude && GPSLongitude) {
            showMap(GPSLatitude, GPSLongitude, GPSLatitudeRef, GPSLongitudeRef);
          }
        }
      });
      cell.textContent = '';
      cell.appendChild(input);
      input.focus();
    }

    function showMap(lat, lng, latRef, lngRef) {
      if (!mapInitialized) {
        map = L.map('map').setView([0, 0], 2);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);
        mapInitialized = true;
      }

      const latitude = convertToDecimal(lat, latRef);
      const longitude = convertToDecimal(lng, lngRef);
      map.setView([latitude, longitude], 13);
      L.marker([latitude, longitude]).addTo(map).bindPopup('Image Location').openPopup();

      // Update Google Maps link dynamically
      const googleMapsUrl = `https://www.google.com/maps?q=${latitude},${longitude}`;
      googleMapsLink.href = googleMapsUrl;
      googleMapsLink.style.display = 'block';
    }

    function convertToDecimal(coord, ref) {
      const [degrees, minutes, seconds] = coord;
      let decimal = degrees + minutes / 60 + seconds / 3600;
      if (ref === 'S' || ref === 'W') decimal *= -1;
      return decimal;
    }

    saveButton.addEventListener('click', () => {
      const blob = new Blob([JSON.stringify(currentMetadata, null, 2)], { type: 'application/json' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = 'edited_metadata.json';
      link.click();
    });
  </script>
</body>
</html>